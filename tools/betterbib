#!/usr/bin/env python
# -*- coding: utf-8 -*-
#
from __future__ import print_function, unicode_literals

import argparse
import collections
from io import open as io_open

# pylint: disable=import-self
import betterbib
from betterbib import pybtex_to_bibtex_string

from pybtex.database.input import bibtex
from tqdm import tqdm


def _main():
    args = _parse_cmd_arguments()
    infile = args.infile

    parser = bibtex.Parser()
    data = parser.parse_file(infile)

    n = len(data.entries)

    sources = [betterbib.Crossref(args.long_journal_name)]

    print('Reading from: %s' % infile)
    print('Saving to: %s\n' % args.outfile)

    # Open output file for writing.
    out = io_open(args.outfile, mode='w', encoding='utf-8')

    # Write header to the output file.
    out.write(
        '%%comment{This file was created with BetterBib v%s.}\n\n' %
        betterbib.__version__
        )

    # Use an ordered dictionary to make sure that the entries are written out
    # sorted by their BibTeX key.
    od = collections.OrderedDict(sorted(data.entries.items()))

    num_success = 0

    for bib_id, entry in tqdm(od.items()):
        result = None
        for source in sources:
            # TODO don't make the sources throw when nothing has been found
            try:
                result = source.find_unique(entry)
            except RuntimeError:
                pass
            else:
                num_success += 1
                break

        if result:
            # Found; write it out to a file.
            a = pybtex_to_bibtex_string(result, bib_id)
        else:
            # Nothing found; write out the old entry to file.
            a = pybtex_to_bibtex_string(entry, bib_id)
            out.write(
                '%comment{Error when fetching the following entry.}\n'
                )

        out.write(a + '\n\n')

    out.close()
    print('\n\nTotal number of entries: %d' % n)
    print('Found: %d' % num_success)

    return


def _parse_cmd_arguments():
    parser = argparse.ArgumentParser(
        description='Improve BibTeX libraries '
        'with information from online sources.'
        )
    parser.add_argument(
        'infile',
        type=str,
        help='input BibTeX file'
        )
    parser.add_argument(
        'outfile',
        type=str,
        help='output BibTeX file'
        )
    parser.add_argument(
        '--long-journal-name', '-l',
        action='store_true',
        help='prefer long journal names (default: false)'
        )
    return parser.parse_args()


if __name__ == '__main__':
    _main()
